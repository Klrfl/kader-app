---
import MainLayout from "@/layouts/MainLayout.astro";
import { newGroupRepo } from "@/repositories/";
import { actions } from "astro:actions";
import { Image } from "astro:assets";

const groups = await newGroupRepo().getVerboseGroups();

const createResult = Astro.getActionResult(actions.groups.create);
if (createResult) {
  if (!createResult.error) return Astro.redirect("/groups");
  else console.error(createResult.error);
}

// TODO: handle upload errors
const uploadResult = Astro.getActionResult(actions.groups.uploadImage);
if (uploadResult) {
  if (!uploadResult.error) return Astro.redirect("/groups");
  else console.error(uploadResult.error);
}
---

<MainLayout>
  <article class="grid gap-8 grid-cols-3">
    <header>
      <h1 class="text-2xl">Groups</h1>
      <p>Showing {groups.length} groups.</p>

      <a href="/groups/print" class="btn btn-primary">Print</a>
    </header>

    <form
      action={actions.groups.create}
      class="flex flex-col gap-4 border-2 border-base-content/20 px-6 py-4 rounded col-end-[-1]"
      method="post"
    >
      <label for="name">Name</label>
      <input
        type="text"
        name="name"
        id="name"
        class="input w-full"
        placeholder="name of the group"
        required
      />

      <button type="submit" class="btn btn-primary">Create new group</button>
    </form>

    <ul class="grid grid-cols-2 lg:grid-cols-3 gap-4 col-span-full">
      {
        groups.map((group) => (
          <li
            class:list={[
              "rounded border px-6 py-4",
              {
                "bg-red-700/30 border-red-700": group.percentage < 30,
              },
              {
                "bg-amber-700/30 border-amber-700": group.percentage > 30,
              },
              {
                "bg-green-700/30 border-green-700": group.percentage === 100,
              },
              {
                "border-base-content/30": group.percentage < 100,
              },
            ]}
          >
            <details>
              <summary class="cursor-pointer">
                <h2 class="text-xl">
                  <a class="link-hover" href={`/students/?group=${group.name}`}>
                    {group.name}
                  </a>
                </h2>
                (bonded with {group.bonded_count} out of {group.student_count},{" "}
                {group.percentage}% progress)
                {group.image_filename && (
                  <Image
                    alt={group.name}
                    src={`/images/${group.image_filename}`}
                    width={400}
                    height={600}
                    class="w-[6in] h-[4in] object-cover"
                  />
                )}
              </summary>

              <form
                action={actions.groups.uploadImage}
                method="post"
                class="flex flex-col gap-4 border-2 border-base-content/20 p-4"
                enctype="multipart/form-data"
              >
                <label for="image">Image</label>
                <input type="hidden" name="group_id" value={group.id} />
                <input
                  type="file"
                  class="file-input w-full"
                  id="image"
                  name="image"
                  accept="image/*"
                  required
                />

                <button type="submit" class="btn btn-primary">
                  Upload image
                </button>
              </form>
            </details>
          </li>
        ))
      }
    </ul>
  </article>
</MainLayout>
